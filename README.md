# OpenShift Event Watcher

The OpenShift Event Watcher is a utility used as a service integrator for OpenShift and other third party components

## Testing Locally

Log into OpenShift and then run a command like the following

```
K8S_TOKEN=`oc whoami -t` K8S_API_ENDPOINT='master.example.com:8443' K8S_NAMESPACE=event-watcher ENV_K8S_CA=./kubernetes.io/serviceaccount/ca.crt K8S_RESOURCE=routes python watch.py
```

You should see a log of data about the Namespace you passed in.

## Configuration

The Event Watcher can be configured via either Environment variables or an ini file. A sample config file can be found at `conf/config.ini.sample`. To run the watcher with a config file, run:

`python3 watch.py --config conf/config.ini`

### Global Configuration Options

| Environment Variable | ini Variable | Required | Description |
| ------------- | ------------- |
| K8S_API_ENDPOINT | k8s_api_endpoint | True | OpenShift/Kubernetes API hostname:port |
| K8S_TOKEN  | k8s_token | True; will be pulled from Pod | Login token (`oc whoami -t`) |
| K8S_NAMESPACE | k8s_namespace | True; will be pulled from Pod | Namespace you want to listen watch resources in |
| K8S_RESOURCE | k8s_resource | True | The `Kind` of the Kubernetes or OpenShift resource |
| K8S_CA | k8s_ca | False; will be pulled from Pod | Path to the `ca.crt` file for the cluster |
| LOG_LEVEL | log_level | False | Logging threshold to be output. Options: DEBUG, INFO, WARNING, ERROR, CRITICAL; Default: INFO
| WATCHER_PLUGIN | watcher_plugin | False | Name of the Plugin you want to run in the Watcher. Default: 'simple' |

## Plugin Architecture

The event watcher is designed to be pluggable. New plugins can be created by simply creating a python module that implements a single `handle_event()` method, which takes a single `dict` object as an argument (the `event` object).

A plugin is invoked like so:

```python
  plugin = load_plugin(plugin_name)
  for k8s_event in getEvents():
    result,level = plugin.handle_event(k8s_event, *args, **kwargs)
    log(result, level)
```

Let's look at a very simple plugin, called `plugin_simple`. This plugin is a single file init file loaded from a directory, `plugin_simple/__init__.py`:

```
def handle_event(event):
    message = "Kind: {0}; Name: {1}".format(event['object']['kind'], event['object']['metadata']['name'])
    log_level = "INFO"
    return message, log_level
```

This plugin takes in the event object generated by the Kubernetes API, grabs a few choice fields, and creates a log message which is returned to the watcher.

From here, we can easily write plugins for the watcher that do things like:

- Create Alerts
- Integrate with Third party systems like DNS or PKI infrastructures

Happy Integrating!
